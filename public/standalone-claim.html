<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Your Attest NFT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .event-info {
            background: #f7f7f7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
        }
        
        .event-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .event-detail {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }
        
        .wallet-status {
            background: #f0f0f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
            color: #333;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .success {
            color: #10b981;
            font-size: 18px;
            margin-top: 20px;
        }
        
        .error {
            color: #ef4444;
            font-size: 14px;
            margin-top: 20px;
            padding: 15px;
            background: #fee;
            border-radius: 8px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .install-phantom {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            color: #856404;
        }
        
        .install-phantom a {
            color: #667eea;
            font-weight: bold;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üéüÔ∏è</div>
        <h1>Claim Your NFT</h1>
        <p class="subtitle">Proof of Attendance</p>
        
        <div id="eventInfo" class="event-info" style="display: none;">
            <div class="event-name" id="eventName"></div>
            <div class="event-detail" id="eventDate"></div>
            <div class="event-detail" id="eventLocation"></div>
        </div>
        
        <div id="walletStatus" class="wallet-status" style="display: none;"></div>
        
        <button id="claimButton" class="button" onclick="handleClaim()">
            Connect Wallet & Claim
        </button>
        
        <div id="message"></div>
        
        <div id="installPhantom" class="install-phantom" style="display: none;">
            Phantom wallet not detected. 
            <a href="https://phantom.app/" target="_blank">Install Phantom</a>
        </div>
    </div>

    <script>
        // Configuration - Update these with your actual values
        const CONFIG = {
            supabaseUrl: 'https://oxjenmddczjtedgyfloe.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94amVubWRkY3pqdGVkZ3lmbG9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1OTI5MzQsImV4cCI6MjA4MTE2ODkzNH0.14Mbnw-7E__wEcPtF5Ifam5aPDqbum50G65ABJkEAdk',
        };

        let wallet = null;
        let eventData = null;

        // Get claim code from URL
        function getClaimCode() {
            const params = new URLSearchParams(window.location.search);
            return params.get('code') || window.location.pathname.split('/').pop();
        }

        // Check if Phantom is installed
        function isPhantomInstalled() {
            return window.solana && window.solana.isPhantom;
        }

        // Connect to Phantom wallet
        async function connectWallet() {
            if (!isPhantomInstalled()) {
                document.getElementById('installPhantom').style.display = 'block';
                throw new Error('Phantom wallet not installed');
            }

            try {
                const resp = await window.solana.connect();
                wallet = resp.publicKey.toString();
                document.getElementById('walletStatus').textContent = `Connected: ${wallet.slice(0, 4)}...${wallet.slice(-4)}`;
                document.getElementById('walletStatus').style.display = 'block';
                return wallet;
            } catch (err) {
                throw new Error('Failed to connect wallet');
            }
        }

        // Fetch event details
        async function fetchEvent(claimCode) {
            const response = await fetch(`${CONFIG.supabaseUrl}/rest/v1/events?claim_code=eq.${claimCode}&is_active=eq.true&select=*`, {
                headers: {
                    'apikey': CONFIG.supabaseKey,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            if (!data || data.length === 0) {
                throw new Error('Event not found');
            }

            return data[0];
        }

        // Sign message
        async function signMessage(message) {
            const encodedMessage = new TextEncoder().encode(message);
            const signedMessage = await window.solana.signMessage(encodedMessage, 'utf8');
            return btoa(String.fromCharCode(...signedMessage.signature));
        }

        // Create claim
        async function createClaim(eventId, walletAddress, signature) {
            const response = await fetch(`${CONFIG.supabaseUrl}/rest/v1/claims`, {
                method: 'POST',
                headers: {
                    'apikey': CONFIG.supabaseKey,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    event_id: eventId,
                    wallet_address: walletAddress,
                    signature: signature,
                    status: 'pending'
                })
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || 'Failed to create claim');
            }

            return data[0];
        }

        // Mint NFT
        async function mintNFT(claimId, eventId, walletAddress, signature) {
            const response = await fetch(`${CONFIG.supabaseUrl}/functions/v1/mint-nft`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${CONFIG.supabaseKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    claimId,
                    eventId,
                    walletAddress,
                    signature
                })
            });

            const data = await response.json();
            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Failed to mint NFT');
            }

            return data;
        }

        // Main claim handler
        async function handleClaim() {
            const button = document.getElementById('claimButton');
            const messageDiv = document.getElementById('message');
            
            button.disabled = true;
            messageDiv.innerHTML = '';

            try {
                // Get claim code
                const claimCode = getClaimCode();
                if (!claimCode) {
                    throw new Error('No claim code provided');
                }

                // Show loading
                button.innerHTML = '<span class="loading"></span>Loading event...';

                // Fetch event
                if (!eventData) {
                    eventData = await fetchEvent(claimCode);
                    document.getElementById('eventName').textContent = eventData.name;
                    document.getElementById('eventDate').textContent = `üìÖ ${new Date(eventData.event_date).toLocaleDateString()}`;
                    document.getElementById('eventLocation').textContent = `üìç ${eventData.location || 'Virtual'}`;
                    document.getElementById('eventInfo').style.display = 'block';
                }

                // Connect wallet
                button.innerHTML = '<span class="loading"></span>Connecting wallet...';
                const walletAddress = await connectWallet();

                // Sign message
                button.innerHTML = '<span class="loading"></span>Please sign message...';
                const message = `Claim Attest NFT for event: ${eventData.name}\nCode: ${claimCode}\nTimestamp: ${Date.now()}`;
                const signature = await signMessage(message);

                // Create claim
                button.innerHTML = '<span class="loading"></span>Creating claim...';
                const claim = await createClaim(eventData.id, walletAddress, signature);

                // Mint NFT
                button.innerHTML = '<span class="loading"></span>Minting NFT... (this may take a minute)';
                const result = await mintNFT(claim.id, eventData.id, walletAddress, signature);

                // Success!
                button.style.display = 'none';
                messageDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ NFT Minted Successfully!<br>
                        <small>Mint: ${result.mintAddress.slice(0, 8)}...${result.mintAddress.slice(-8)}</small>
                    </div>
                `;

            } catch (error) {
                console.error('Claim error:', error);
                messageDiv.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
                button.disabled = false;
                button.innerHTML = 'Try Again';
            }
        }

        // Initialize on load
        window.addEventListener('load', async () => {
            const claimCode = getClaimCode();
            if (claimCode) {
                try {
                    eventData = await fetchEvent(claimCode);
                    document.getElementById('eventName').textContent = eventData.name;
                    document.getElementById('eventDate').textContent = `üìÖ ${new Date(eventData.event_date).toLocaleDateString()}`;
                    document.getElementById('eventLocation').textContent = `üìç ${eventData.location || 'Virtual'}`;
                    document.getElementById('eventInfo').style.display = 'block';
                } catch (error) {
                    document.getElementById('message').innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
                }
            }
        });
    </script>
</body>
</html>
